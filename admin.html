<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Rubik', sans-serif; background: url('https://i.postimg.cc/XvNGRmbb/wallpapersden-com-ellen-joe-zenless-zone-zero-1920x1259.jpg') no-repeat center center fixed; background-size: cover; color:#fff; }
</style>
</head>
<body class="min-h-screen p-6">

<header class="flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold text-purple-400">🖥 Dashboard</h1>
  <button id="toggleMusic" class="bg-purple-600 px-3 py-1 rounded hover:bg-purple-700">⏸ Tắt nhạc</button>
</header>

<audio id="bgMusic" autoplay loop>
  <source src="https://github.com/thangtranne2023/w-azure/raw/refs/heads/main/DONALD%20GOLD%20-%20ADAMN%20%20%5BOFFICIAL%20MV%5D.mp3?raw=true" type="audio/mpeg">
</audio>

<!-- Admin Panel -->
<div id="adminPanel" class="space-y-10" style="display:none;">
  <!-- Thêm sản phẩm -->
  <section>
    <h2 class="text-2xl font-semibold mb-4">🛒 Thêm sản phẩm</h2>
    <div class="bg-[#1c1c1c] p-6 rounded-xl border border-zinc-700 max-w-2xl space-y-4">
      <input type="text" id="productName" placeholder="Tên sản phẩm" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <textarea id="productDesc" placeholder="Mô tả sản phẩm" class="w-full bg-zinc-800 p-2 rounded text-white"></textarea>
      <div class="flex space-x-4">
        <input type="number" id="productPrice" placeholder="Giá gốc" class="flex-1 bg-zinc-800 p-2 rounded text-white" />
        <input type="number" id="productDiscount" placeholder="Giá KM" class="flex-1 bg-zinc-800 p-2 rounded text-white" />
      </div>
      <input type="url" id="productImage" placeholder="Link hình ảnh" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <input type="number" id="productQuantity" placeholder="Số lượng key" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <button id="btnAddProduct" class="mt-2 bg-purple-600 px-4 py-2 rounded hover:bg-purple-700">➕ Thêm sản phẩm</button>
    </div>
  </section>

  <!-- Danh sách sản phẩm -->
  <section>
    <h2 class="text-xl font-semibold mb-3">📦 Danh sách sản phẩm</h2>
    <div id="productList" class="max-w-2xl"></div>
  </section>

  <!-- Thêm tiền -->
  <section>
    <h2 class="text-2xl font-semibold mb-4">💰 Thêm tiền cho user</h2>
    <div class="bg-[#1c1c1c] p-4 rounded-xl border border-zinc-700 max-w-lg space-y-3">
      <input type="text" id="targetUser" placeholder="Tên người dùng (username)" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <input type="number" id="amount" placeholder="Số tiền cần cộng" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <button id="btnAddBalance" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">➕ Thêm tiền</button>
    </div>
  </section>

  <!-- Quản lý tài khoản -->
  <section>
    <h2 class="text-2xl font-semibold mb-4">👥 Quản lý tài khoản</h2>
    <div class="bg-[#1c1c1c] p-4 rounded-xl border border-zinc-700 max-w-4xl overflow-auto">
      <table class="w-full text-sm text-left border-collapse">
        <thead class="text-purple-300 border-b border-zinc-700">
          <tr>
            <th class="p-2">#</th>
            <th class="p-2">Username</th>
            <th class="p-2">Email</th>
            <th class="p-2">Số dư</th>
            <th class="p-2">Trạng thái</th>
            <th class="p-2">Hành động</th>
          </tr>
        </thead>
        <tbody id="accountList" class="text-gray-300"></tbody>
      </table>
    </div>
  </section>
</div>

<!-- User Panel -->
<div id="userPanel" style="display:none;">
  <h2 class="text-2xl font-semibold mb-4">👤 Thông tin tài khoản</h2>
  <div class="bg-[#1c1c1c] p-4 rounded-xl max-w-md space-y-3">
    <div>Username: <span id="userName"></span></div>
    <div>Email: <span id="userEmail"></span></div>
    <div>Số dư: <span id="userBalance"></span></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDocs, query, where, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyANCoHCTlrQlrt-9XrYt4kMLJ0JmcdW3is",
  authDomain: "shiinamahiru.firebaseapp.com",
  projectId: "shiinamahiru",
  storageBucket: "shiinamahiru.firebasestorage.app",
  messagingSenderId: "639368679466",
  appId: "1:639368679466:web:c2886952ea91599ec9b353"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const music = document.getElementById("bgMusic");
const musicBtn = document.getElementById("toggleMusic");
let playing = true;
musicBtn.addEventListener("click", ()=>{ 
  if(!playing){ music.play(); musicBtn.textContent="⏸ Tắt nhạc"; } 
  else { music.pause(); musicBtn.textContent="▶ Bật nhạc"; } 
  playing=!playing; 
});

onAuthStateChanged(auth, async (user)=>{
  if(!user){ alert("Vui lòng đăng nhập"); window.location.href="login.html"; return; }

  const uSnap = await getDocs(query(collection(db, "users"), where("__name__", "==", user.uid)));
  if(uSnap.empty){ alert("User chưa tồn tại"); return; }
  const uData = uSnap.docs[0].data();
  const role = uData.role || "user";

  if(role==="admin"){ 
    document.getElementById("adminPanel").style.display="block";
    loadProducts();
    loadUsers();
  } else {
    document.getElementById("userPanel").style.display="block";
    document.getElementById("userName").textContent = uData.username;
    document.getElementById("userEmail").textContent = uData.email;
    document.getElementById("userBalance").textContent = uData.balance || 0;
  }
});

// ---------- Admin functions ----------
async function loadProducts(){
  const snap = await getDocs(collection(db,"products"));
  const list = document.getElementById("productList");
  list.innerHTML="";
  snap.forEach(d=>{
    const p=d.data();
    list.innerHTML+=`<div class="bg-zinc-800 p-4 rounded mb-3 flex justify-between items-center">
      <div><div class="font-semibold">${p.name}</div>
      <div class="text-sm text-gray-400">Giá: ${p.price} | KM: ${p.discount||0} | SL: ${p.quantity}</div></div>
      <div><button onclick="deleteProduct('${d.id}')" class="text-red-500 hover:underline text-sm">Xóa</button></div>
    </div>`;
  });
}
window.deleteProduct=async function(id){ if(confirm("Xóa sản phẩm?")){ await deleteDoc(doc(db,"products",id)); loadProducts(); } }

document.getElementById("btnAddProduct")?.addEventListener("click", async()=>{
  const name=document.getElementById("productName").value.trim();
  const desc=document.getElementById("productDesc").value.trim();
  const price=Number(document.getElementById("productPrice").value)||0;
  const discount=Number(document.getElementById("productDiscount").value)||0;
  const image=document.getElementById("productImage").value.trim();
  const quantity=parseInt(document.getElementById("productQuantity").value)||0;
  if(!name||!quantity) return alert("Vui lòng điền tên + SL key");
  const pRef=await addDoc(collection(db,"products"),{name,desc,price,discount,image,quantity,createdAt:new Date().toISOString()});
  for(let i=0;i<quantity;i++){
    const key=`KEY-${Math.random().toString(36).slice(2,9)}-${Date.now().toString().slice(-4)}-${i}`;
    await addDoc(collection(db,"products",pRef.id,"keys"),{value:key,used:false,createdAt:new Date().toISOString()});
  }
  alert("✅ Đã thêm sản phẩm & tạo key"); loadProducts();
});

document.getElementById("btnAddBalance")?.addEventListener("click", async()=>{
  const username=document.getElementById("targetUser").value.trim();
  const amount=Number(document.getElementById("amount").value)||0;
  if(!username||amount<=0) return alert("Nhập username + số tiền hợp lệ");
  const snap=await getDocs(query(collection(db,"users"),where("username","==",username)));
  if(snap.empty) return alert("User không tồn tại");
  const uid=snap.docs[0].id;
  const cur=snap.docs[0].data().balance||0;
  await updateDoc(doc(db,"users",uid),{balance:cur+amount});
  alert("✅ Đã cộng tiền");
  loadUsers();
});

async function loadUsers(){
  const snap=await getDocs(collection(db,"users"));
  const tb=document.getElementById("accountList");
  tb.innerHTML="";
  let idx=0;
  snap.forEach(d=>{
    const u=d.data();
    const uid=d.id;
    const status=u.locked?"🔒 Khoá":"✅ Bình thường";
    tb.innerHTML+=`<tr class="border-b border-zinc-700">
      <td class="p-2">${++idx}</td>
      <td class="p-2">${u.username||'(no-name)'}</td>
      <td class="p-2">${u.email||'-'}</td>
      <td class="p-2">${u.balance||0}</td>
      <td class="p-2">${status}</td>
      <td class="p-2 space-x-2">
        <button onclick="toggleLock('${uid}')" class="text-yellow-400 hover:underline text-xs">${u.locked?'Mở khoá':'Khoá'}</button>
        <button onclick="resetPassword('${u.email}')" class="text-red-400 hover:underline text-xs">Đặt lại MK</button>
      </td>
    </tr>`;
  });
}

window.toggleLock=async(uid)=>{
  const uRef=doc(db,"users",uid);
  const snap=await getDocs(query(collection(db,"users"),where("__name__","==",uid)));
  if(snap.empty) return alert("User not found");
  const curSnap=await getDocs(collection(db,"users"));
  let found=null;
  curSnap.forEach(d=>{if(d.id===uid) found=d;});
  if(!found) return alert("User not found");
  const currentLocked=found.data().locked||false;
  await updateDoc(uRef,{locked:!currentLocked});
  alert(`Đã ${!currentLocked?'khoá':'mở khoá'} user`);
  loadUsers();
};

window.resetPassword=async(email)=>{
  if(!email) return alert("User chưa có email");
  if(!confirm("Gửi email reset tới: "+email+" ?")) return;
  await sendPasswordResetEmail(auth,email);
  alert("✅ Email reset đã gửi");
};
</script>

</body>
</html>
