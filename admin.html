<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Rubik', sans-serif;
      background: url('https://i.postimg.cc/XvNGRmbb/wallpapersden-com-ellen-joe-zenless-zone-zero-1920x1259.jpg') no-repeat center center fixed;
      background-size: cover;
      color:#fff;
    }
  </style>
</head>
<body class="min-h-screen">
  <header class="bg-[#161616] shadow-md p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-purple-400">ADMIN PANEL</h1>
    <a href="index.html" class="text-sm text-gray-300 hover:text-white">‚Üê V·ªÅ trang ch·ªß</a>
  </header>

  <main class="p-6 space-y-10">
    <!-- Th√™m s·∫£n ph·∫©m -->
    <section>
      <h2 class="text-2xl font-semibold mb-4">üõí Th√™m s·∫£n ph·∫©m</h2>
      <div class="bg-[#1c1c1c] p-6 rounded-xl border border-zinc-700 max-w-2xl space-y-4">
        <input type="text" id="productName" placeholder="T√™n s·∫£n ph·∫©m" class="w-full bg-zinc-800 p-2 rounded text-white" />
        <textarea id="productDesc" placeholder="M√¥ t·∫£ s·∫£n ph·∫©m" class="w-full bg-zinc-800 p-2 rounded text-white"></textarea>
        <div class="flex space-x-4">
          <input type="number" id="productPrice" placeholder="Gi√° g·ªëc" class="flex-1 bg-zinc-800 p-2 rounded text-white" />
          <input type="number" id="productDiscount" placeholder="Gi√° KM" class="flex-1 bg-zinc-800 p-2 rounded text-white" />
        </div>
        <input type="url" id="productImage" placeholder="Link h√¨nh ·∫£nh" class="w-full bg-zinc-800 p-2 rounded text-white" />
        <input type="number" id="productQuantity" placeholder="S·ªë l∆∞·ª£ng key" class="w-full bg-zinc-800 p-2 rounded text-white" />
        <button id="btnAddProduct" class="mt-2 bg-purple-600 px-4 py-2 rounded hover:bg-purple-700">‚ûï Th√™m s·∫£n ph·∫©m</button>
      </div>
    </section>

    <!-- Danh s√°ch s·∫£n ph·∫©m -->
    <section>
      <h2 class="text-xl font-semibold mb-3">üì¶ Danh s√°ch s·∫£n ph·∫©m</h2>
      <div id="productList" class="max-w-2xl"></div>
    </section>

    <!-- Th√™m ti·ªÅn -->
    <hr class="border-zinc-700 my-6" />
    <section>
      <h2 class="text-2xl font-semibold mb-4">üí∞ Th√™m ti·ªÅn cho user</h2>
      <div class="bg-[#1c1c1c] p-4 rounded-xl border border-zinc-700 max-w-lg space-y-3">
        <input type="text" id="targetUser" placeholder="T√™n ng∆∞·ªùi d√πng (username)" class="w-full bg-zinc-800 p-2 rounded text-white" />
        <input type="number" id="amount" placeholder="S·ªë ti·ªÅn c·∫ßn c·ªông" class="w-full bg-zinc-800 p-2 rounded text-white" />
        <button id="btnAddBalance" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">‚ûï Th√™m ti·ªÅn</button>
      </div>
    </section>

    <!-- Qu·∫£n l√Ω t√†i kho·∫£n -->
    <hr class="border-zinc-700 my-6" />
    <section>
      <h2 class="text-2xl font-semibold mb-4">üë• Qu·∫£n l√Ω t√†i kho·∫£n</h2>
      <div class="bg-[#1c1c1c] p-4 rounded-xl border border-zinc-700 max-w-4xl overflow-auto">
        <table class="w-full text-sm text-left border-collapse">
          <thead class="text-purple-300 border-b border-zinc-700">
            <tr>
              <th class="p-2">#</th>
              <th class="p-2">Username</th>
              <th class="p-2">Email</th>
              <th class="p-2">S·ªë d∆∞</th>
              <th class="p-2">Tr·∫°ng th√°i</th>
              <th class="p-2">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="accountList" class="text-gray-300"></tbody>
        </table>
      </div>
    </section>
  </main>

  <button id="toggleMusic">‚è∏ T·∫Øt nh·∫°c</button>
  <audio id="bgMusic" autoplay loop>
    <source src="https://github.com/thangtranne2023/w-azure/raw/refs/heads/main/DONALD%20GOLD%20-%20ADAMN%20%20%5BOFFICIAL%20MV%5D.mp3?raw=true" type="audio/mpeg">
  </audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, getDocs, query, where, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyANCoHCTlrQlrt-9XrYt4kMLJ0JmcdW3is",
  authDomain: "shiinamahiru.firebaseapp.com",
  projectId: "shiinamahiru",
  storageBucket: "shiinamahiru.firebasestorage.app",
  messagingSenderId: "639368679466",
  appId: "1:639368679466:web:c2886952ea91599ec9b353"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// music
const music = document.getElementById("bgMusic");
const musicBtn = document.getElementById("toggleMusic");
let playing = true;
window.addEventListener("load", ()=>{ music.play().catch(()=>{ musicBtn.textContent="‚ñ∂ B·∫≠t nh·∫°c"; playing=false; }); });
musicBtn.addEventListener("click", ()=>{ if(!playing){ music.play(); musicBtn.textContent="‚è∏ T·∫Øt nh·∫°c"; } else { music.pause(); musicBtn.textContent="‚ñ∂ B·∫≠t nh·∫°c"; } playing=!playing; });

// ADMIN GUARD
onAuthStateChanged(auth, async (user) => {
  if(!user){
    alert("Vui l√≤ng ƒëƒÉng nh·∫≠p admin");
    window.location.href = "login.html";
    return;
  }
  try {
    const userDocRef = doc(db, "users", user.uid);
    const userSnap = await getDocs(query(collection(db,"users"),where("__name__","==",user.uid)));
    let isAdmin = false;
    if(!userSnap.empty && userSnap.docs[0].data().role === "admin") isAdmin = true;
    if(!isAdmin){
      alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!");
      window.location.href = "index.html";
      return;
    }
    // load data
    loadProducts();
    loadUsers();
  } catch(err){
    console.error(err);
    alert("L·ªói ki·ªÉm tra quy·ªÅn: " + err.message);
    window.location.href = "index.html";
  }
});

// ADD PRODUCT
document.getElementById("btnAddProduct").addEventListener("click", async () => {
  const name = document.getElementById("productName").value.trim();
  const desc = document.getElementById("productDesc").value.trim();
  const price = Number(document.getElementById("productPrice").value) || 0;
  const discount = Number(document.getElementById("productDiscount").value) || 0;
  const image = document.getElementById("productImage").value.trim();
  const quantity = parseInt(document.getElementById("productQuantity").value) || 0;
  if (!name || !quantity) return alert("Vui l√≤ng ƒëi·ªÅn ƒë·ªß tr∆∞·ªùng (t·ªëi thi·ªÉu t√™n + quantity).");

  try {
    const pRef = await addDoc(collection(db, "products"), {
      name, desc, price, discount, image, quantity, createdAt: new Date().toISOString()
    });
    for(let i=0;i<quantity;i++){
      const key = `KEY-${Math.random().toString(36).slice(2,9)}-${Date.now().toString().slice(-4)}-${i}`;
      await addDoc(collection(db,"products",pRef.id,"keys"),{ value:key, used:false, createdAt: new Date().toISOString() });
    }
    alert("‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m v√† t·∫°o keys.");
    document.getElementById("productName").value="";
    document.getElementById("productDesc").value="";
    document.getElementById("productPrice").value="";
    document.getElementById("productDiscount").value="";
    document.getElementById("productImage").value="";
    document.getElementById("productQuantity").value="";
    loadProducts();
  }catch(err){ console.error(err); alert("L·ªói th√™m s·∫£n ph·∫©m: "+err.message); }
});

// LOAD PRODUCTS
async function loadProducts(){
  const snap = await getDocs(collection(db,"products"));
  const list = document.getElementById("productList");
  list.innerHTML="";
  snap.forEach(docSnap=>{
    const p=docSnap.data(), id=docSnap.id;
    list.innerHTML += `<div class="bg-zinc-800 p-4 rounded mb-3 flex justify-between items-center">
      <div><div class="font-semibold">${p.name}</div>
      <div class="text-sm text-gray-400">Gi√°: ${p.price} | KM: ${p.discount||0} | SL: ${p.quantity}</div></div>
      <div><button onclick="deleteProduct('${id}')" class="text-red-500 hover:underline text-sm mr-4">X√≥a</button></div>
    </div>`;
  });
}

window.deleteProduct = async function(productId){
  if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?")) return;
  try{ await deleteDoc(doc(db,"products",productId)); alert("ƒê√£ x√≥a."); loadProducts(); }
  catch(err){ console.error(err); alert("L·ªói x√≥a: "+err.message); }
}

// ADD BALANCE
document.getElementById("btnAddBalance").addEventListener("click", async ()=>{
  const username = document.getElementById("targetUser").value.trim();
  const amount = Number(document.getElementById("amount").value) || 0;
  if(!username || amount<=0) return alert("Nh·∫≠p username v√† amount h·ª£p l·ªá.");
  try{
    const snap = await getDocs(query(collection(db,"users"),where("username","==",username)));
    if(snap.empty) return alert("User kh√¥ng t·ªìn t·∫°i.");
    const uDoc = snap.docs[0], uid = uDoc.id, cur = uDoc.data().balance||0;
    await updateDoc(doc(db,"users",uid),{balance: cur+amount});
    alert("‚úÖ ƒê√£ c·ªông ti·ªÅn.");
    loadUsers();
  }catch(err){ console.error(err); alert("L·ªói c·ªông ti·ªÅn: "+err.message); }
});

// LOAD USERS
async function loadUsers(){
  const snap = await getDocs(collection(db,"users"));
  const tb = document.getElement
