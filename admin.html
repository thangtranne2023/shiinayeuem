<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Rubik', sans-serif; background: url('https://i.postimg.cc/XvNGRmbb/wallpapersden-com-ellen-joe-zenless-zone-zero-1920x1259.jpg') no-repeat center center fixed; background-size: cover; color:#fff; }
</style>
</head>
<body class="min-h-screen">

<header class="bg-[#161616] shadow-md p-4 flex justify-between items-center">
  <h1 class="text-xl font-bold text-purple-400">ADMIN PANEL</h1>
  <a href="index.html" class="text-sm text-gray-300 hover:text-white">â† Vá» trang chá»§</a>
</header>

<main class="p-6 space-y-10">

  <!-- ThÃªm sáº£n pháº©m -->
  <section>
    <h2 class="text-2xl font-semibold mb-4">ğŸ›’ ThÃªm sáº£n pháº©m</h2>
    <div class="bg-[#1c1c1c] p-6 rounded-xl border border-zinc-700 max-w-2xl space-y-4">
      <input type="text" id="productName" placeholder="TÃªn sáº£n pháº©m" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <textarea id="productDesc" placeholder="MÃ´ táº£ sáº£n pháº©m" class="w-full bg-zinc-800 p-2 rounded text-white"></textarea>
      <div class="flex space-x-4">
        <input type="number" id="productPrice" placeholder="GiÃ¡ gá»‘c" class="flex-1 bg-zinc-800 p-2 rounded text-white" />
        <input type="number" id="productDiscount" placeholder="GiÃ¡ KM" class="flex-1 bg-zinc-800 p-2 rounded text-white" />
      </div>
      <input type="url" id="productImage" placeholder="Link hÃ¬nh áº£nh" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <input type="number" id="productQuantity" placeholder="Sá»‘ lÆ°á»£ng key" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <button id="btnAddProduct" class="mt-2 bg-purple-600 px-4 py-2 rounded hover:bg-purple-700">â• ThÃªm sáº£n pháº©m</button>
    </div>
  </section>

  <!-- Danh sÃ¡ch sáº£n pháº©m -->
  <section>
    <h2 class="text-xl font-semibold mb-3">ğŸ“¦ Danh sÃ¡ch sáº£n pháº©m</h2>
    <div id="productList" class="max-w-2xl"></div>
  </section>

  <!-- ThÃªm tiá»n -->
  <hr class="border-zinc-700 my-6" />
  <section>
    <h2 class="text-2xl font-semibold mb-4">ğŸ’° ThÃªm tiá»n cho user</h2>
    <div class="bg-[#1c1c1c] p-4 rounded-xl border border-zinc-700 max-w-lg space-y-3">
      <input type="text" id="targetUser" placeholder="TÃªn ngÆ°á»i dÃ¹ng (username)" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <input type="number" id="amount" placeholder="Sá»‘ tiá»n cáº§n cá»™ng" class="w-full bg-zinc-800 p-2 rounded text-white" />
      <button id="btnAddBalance" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">â• ThÃªm tiá»n</button>
    </div>
  </section>

  <!-- Quáº£n lÃ½ tÃ i khoáº£n -->
  <hr class="border-zinc-700 my-6" />
  <section>
    <h2 class="text-2xl font-semibold mb-4">ğŸ‘¥ Quáº£n lÃ½ tÃ i khoáº£n</h2>
    <div class="bg-[#1c1c1c] p-4 rounded-xl border border-zinc-700 max-w-4xl overflow-auto">
      <table class="w-full text-sm text-left border-collapse">
        <thead class="text-purple-300 border-b border-zinc-700">
          <tr>
            <th class="p-2">#</th>
            <th class="p-2">Username</th>
            <th class="p-2">Email</th>
            <th class="p-2">Sá»‘ dÆ°</th>
            <th class="p-2">Tráº¡ng thÃ¡i</th>
            <th class="p-2">HÃ nh Ä‘á»™ng</th>
          </tr>
        </thead>
        <tbody id="accountList" class="text-gray-300"></tbody>
      </table>
    </div>
  </section>

</main>

<button id="toggleMusic" class="fixed bottom-5 right-5 bg-purple-600 px-4 py-2 rounded">â¸ Táº¯t nháº¡c</button>
<audio id="bgMusic" autoplay loop>
  <source src="https://github.com/thangtranne2023/w-azure/raw/refs/heads/main/DONALD%20GOLD%20-%20ADAMN%20%20%5BOFFICIAL%20MV%5D.mp3?raw=true" type="audio/mpeg">
</audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDocs, query, where, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyANCoHCTlrQlrt-9XrYt4kMLJ0JmcdW3is",
  authDomain: "shiinamahiru.firebaseapp.com",
  projectId: "shiinamahiru",
  storageBucket: "shiinamahiru.firebasestorage.app",
  messagingSenderId: "639368679466",
  appId: "1:639368679466:web:c2886952ea91599ec9b353"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const music = document.getElementById("bgMusic");
const musicBtn = document.getElementById("toggleMusic");
let playing = true;
window.addEventListener("load", ()=>{ music.play().catch(()=>{ musicBtn.textContent="â–¶ Báº­t nháº¡c"; playing=false; }); });
musicBtn.addEventListener("click", ()=>{ if(!playing){ music.play(); musicBtn.textContent="â¸ Táº¯t nháº¡c"; } else { music.pause(); musicBtn.textContent="â–¶ Báº­t nháº¡c"; } playing=!playing; });

// Admin guard
onAuthStateChanged(auth, async (user) => {
  if (!user) { alert("Vui lÃ²ng Ä‘Äƒng nháº­p admin"); window.location.href = "login.html"; return; }
  try {
    const docSnap = await getDocs(query(collection(db, "users"), where("__name__", "==", user.uid)));
    let isAdmin = false;
    if (!docSnap.empty) { const d=docSnap.docs[0].data(); if(d.role==="admin") isAdmin=true; }
    if(!isAdmin) { alert("Báº¡n khÃ´ng cÃ³ quyá»n truy cáº­p!"); window.location.href="index.html"; return; }
    loadProducts(); loadUsers();
  } catch(err){ console.error(err); alert("Lá»—i quyá»n: "+err.message); window.location.href="index.html"; }
});

// ADD PRODUCT
document.getElementById("btnAddProduct").addEventListener("click", async ()=>{
  const name = document.getElementById("productName").value.trim();
  const desc = document.getElementById("productDesc").value.trim();
  const price = Number(document.getElementById("productPrice").value)||0;
  const discount = Number(document.getElementById("productDiscount").value)||0;
  const image = document.getElementById("productImage").value.trim();
  const quantity = parseInt(document.getElementById("productQuantity").value)||0;
  if(!name||!quantity)return alert("Vui lÃ²ng Ä‘iá»n Ä‘á»§ trÆ°á»ng.");

  try {
    const pRef = await addDoc(collection(db,"products"),{name,desc,price,discount,image,quantity,createdAt:new Date().toISOString()});
    for(let i=0;i<quantity;i++){
      const key=`KEY-${Math.random().toString(36).slice(2,9)}-${Date.now().toString().slice(-4)}-${i}`;
      await addDoc(collection(db,"products",pRef.id,"keys"),{value:key,used:false,createdAt:new Date().toISOString()});
    }
    alert("âœ… ÄÃ£ thÃªm sáº£n pháº©m vÃ  táº¡o keys.");
    ["productName","productDesc","productPrice","productDiscount","productImage","productQuantity"].forEach(id=>document.getElementById(id).value="");
    loadProducts();
  }catch(err){ console.error(err); alert("Lá»—i thÃªm sáº£n pháº©m: "+err.message);}
});

// LOAD PRODUCTS
async function loadProducts(){
  const snap = await getDocs(collection(db,"products"));
  const list = document.getElementById("productList"); list.innerHTML="";
  snap.forEach(docSnap=>{
    const p=docSnap.data(); const id=docSnap.id;
    list.innerHTML+=`<div class="bg-zinc-800 p-4 rounded mb-3 flex justify-between items-center">
      <div><div class="font-semibold">${p.name}</div>
      <div class="text-sm text-gray-400">GiÃ¡: ${p.price} | KM: ${p.discount||0} | SL: ${p.quantity}</div></div>
      <div><button onclick="deleteProduct('${id}')" class="text-red-500 hover:underline text-sm mr-4">XÃ³a</button></div>
    </div>`;
  });
}

window.deleteProduct=async function(productId){
  if(!confirm("Báº¡n cháº¯c cháº¯n muá»‘n xÃ³a sáº£n pháº©m nÃ y?")) return;
  try{ await deleteDoc(doc(db,"products",productId)); alert("ÄÃ£ xÃ³a."); loadProducts(); }
  catch(err){ console.error(err); alert("Lá»—i xÃ³a: "+err.message);}
}

// ADD BALANCE
document.getElementById("btnAddBalance").addEventListener("click", async ()=>{
  const username=document.getElementById("targetUser").value.trim();
  const amount=Number(document.getElementById("amount").value)||0;
  if(!username||amount<=0)return alert("Nháº­p username vÃ  amount há»£p lá»‡.");
  try{
    const snap = await getDocs(query(collection(db,"users"),where("username","==",username)));
    if(snap.empty)return alert("User khÃ´ng tá»“n táº¡i.");
    const uDoc=snap.docs[0]; const uid=uDoc.id;
    const cur=uDoc.data().balance||0;
    await updateDoc(doc(db,"users",uid),{balance:cur+amount});
    alert("âœ… ÄÃ£ cá»™ng tiá»n."); loadUsers();
  }catch(err){ console.error(err); alert("Lá»—i cá»™ng tiá»n: "+err.message);}
});

// LOAD USERS
async function loadUsers(){
  const snap = await getDocs(collection(db,"users"));
  const tb=document.getElementById("accountList"); tb.innerHTML="";
  let idx=0;
  snap.forEach(docSnap=>{
    const u=docSnap.data(); const uid=docSnap.id;
    const status=u.locked?"ğŸ”’ KhoÃ¡":"âœ… BÃ¬nh thÆ°á»ng";
    tb.innerHTML+=`<tr class="border-b border-zinc-700">
      <td class="p-2">${++idx}</td>
      <td class="p-2">${u.username||'(no-name)'}</td>
      <td class="p-2">${u.email||'-'}</td>
      <td class="p-2">${u.balance||0}</td>
      <td class="p-2">${status}</td>
      <td class="p-2 space-x-2">
        <button onclick="toggleLock('${uid}')" class="text-yellow-400 hover:underline text-xs">${u.locked?'Má»Ÿ khoÃ¡':'KhoÃ¡'}</button>
        <button onclick="resetPassword('${u.email}')" class="text-red-400 hover:underline text-xs">Äáº·t láº¡i MK</button>
      </td>
    </tr>`;
  });
}

window.toggleLock=async function(uid){
  try{
    const uRef=doc(db,"users",uid); const uSnap=await getDocs(query(collection(db,"users"),where("__name__","==",uid)));
    const usersAll=await getDocs(collection(db,"users")); let found=null; usersAll.forEach(d=>{if(d.id===uid)found=d;});
    if(!found)return alert("User not found");
    const currentLocked=found.data().locked||false;
    await updateDoc(doc(db,"users",uid),{locked:!currentLocked});
    alert(`ÄÃ£ ${!currentLocked?'khoÃ¡':'má»Ÿ khoÃ¡'} user.`); loadUsers();
  }catch(err){ console.error(err); alert("Lá»—i toggle lock: "+err.message);}
}

window.resetPassword=async function(email){
  if(!email)return alert("User chÆ°a cÃ³ email."); if(!confirm("Gá»­i email Ä‘áº·t láº¡i máº­t kháº©u tá»›i: "+email+" ?")) return;
  try{ await sendPasswordResetEmail(auth,email); alert("âœ… Email reset Ä‘Ã£ gá»­i."); }
  catch(err){ console.error(err); alert("Lá»—i gá»­i email reset: "+err.message);}
}
</script>

</body>
</html>
